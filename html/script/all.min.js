var hahaApp,__awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(s,i){function a(e){try{d(n.next(e))}catch(e){i(e)}}function r(e){try{d(n.throw(e))}catch(e){i(e)}}function d(e){e.done?s(e.value):new o(function(t){t(e.value)}).then(a,r)}d((n=n.apply(e,t||[])).next())})};!function(e){const t=new Ammo.btTransform,o=new Ammo.btVector3,n=new Ammo.btQuaternion(1,0,0,0),s=new THREE.Matrix4,i=new THREE.Matrix4,a=new THREE.Vector3,r=new THREE.Quaternion,d=new THREE.Quaternion;e.Object=class{constructor(e,i,d,c){this.mass=e,this.collisionShape=i,this.object3D=d,this.object3D.updateMatrixWorld(),a.setFromMatrixPosition(this.object3D.matrixWorld),r.setFromRotationMatrix(s.extractRotation(this.object3D.matrixWorld)),o.setValue(a.x,a.y,a.z),n.setValue(r.x,r.y,r.z,r.w),t.setOrigin(o),t.setRotation(n);const l=new Ammo.btDefaultMotionState(t);c||0==e||(i.calculateLocalInertia(e,o),c=o);const h=new Ammo.btRigidBodyConstructionInfo(e,l,i,0!=e?c:void 0);this.motionState=l,this.rigidBody=new Ammo.btRigidBody(h),0==e&&this.rigidBody.setCollisionFlags(1)}update(e){this.sync()}sync(){if(0!=this.mass){this.motionState.getWorldTransform(t);const e=t.getRotation(),o=t.getOrigin();a.set(o.x(),o.y(),o.z()),r.set(e.x(),e.y(),e.z(),e.w()),this.object3D.parent&&(s.copy(this.object3D.parent.matrixWorld).invert(),d.setFromRotationMatrix(i.extractRotation(s)),r.premultiply(d),a.applyMatrix4(s)),this.object3D.quaternion.copy(r),this.object3D.position.copy(a)}}updateRigidBodyTransform(){a.setFromMatrixPosition(this.object3D.matrixWorld),r.setFromRotationMatrix(s.extractRotation(this.object3D.matrixWorld)),o.setValue(a.x,a.y,a.z),n.setValue(r.x,r.y,r.z,r.w),t.setOrigin(o),t.setRotation(n),this.rigidBody.setWorldTransform(t),this.motionState.setWorldTransform(t)}}}(hahaApp||(hahaApp={})),function(e){const t=new THREE.Vector2,o=new THREE.Vector2,n=new THREE.Vector3,s=(new THREE.Vector4,new THREE.Vector2(1,-1)),i=new THREE.Matrix4,a=(new THREE.Matrix4,new Ammo.btVector3),r=new Ammo.btTransform;class d extends e.Object{update(e){super.update(e),this.object3D.rotateY(Math.PI*e/10),this.object3D.updateMatrixWorld(),this.updateRigidBodyTransform()}}function c(e){e.traverse(e=>{if(e.isMesh){const t=e.material;if(t instanceof THREE.MeshStandardMaterial){for(let e of[t.map,t.normalMap,t.roughnessMap,t.metalnessMap])e&&16!=e.anisotropy&&(e.anisotropy=16,e.needsUpdate=!0);t.side==THREE.DoubleSide&&(t.side=THREE.FrontSide,t.needsUpdate=!0)}}})}e.setAnisotropic=c;e.App=class{constructor(t){this.canvas=t,this.hud=new e.HUD,this.objects=[],this.softBodies=[],this.passes=new Map,this.timeElapsed=0,this.mousePressed=!1,this.pointerMove=new THREE.Vector2,this.pointerPosition=new THREE.Vector2,this.fpsCounter=0,this.player=new e.Player,this.audio=new e.AudioManager,this.contacts=new WeakMap;let o=t.getBoundingClientRect();t.width=o.width,t.height=o.height;const n=t.getContext("webgl2",{depth:!0});this.renderer=new THREE.WebGLRenderer({context:n}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.setSize(o.width,o.height),this.renderer.setClearColor("#0000ff"),this.effectComposer=new THREE.EffectComposer(this.renderer),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(50,o.width/o.height);const s=new THREE.RenderPass(this.scene,this.camera);this.effectComposer.addPass(s);const i=new THREE.SMAAPass(o.width,o.height);this.effectComposer.addPass(i);const a=new THREE.BokehPass(this.scene,this.camera,{focus:5,maxblur:.01,aperture:5e-5});a.needsSwap=!0,this.effectComposer.addPass(a);const r=new THREE.UnrealBloomPass(new THREE.Vector2(o.width,o.height),.2);this.effectComposer.addPass(r),this.passes.set("smaa",i),this.passes.set("dof",a),this.passes.set("bloom",r),t.addEventListener("mousedown",e=>{this.onMouseDown(e)}),t.addEventListener("mouseup",e=>{this.onMouseUp(e)}),t.addEventListener("mousemove",e=>{this.onMouseMove(e)}),t.addEventListener("touchstart",e=>{this.onTouchStart(e)}),t.addEventListener("touchmove",e=>{this.onTouchMove(e)}),t.addEventListener("touchend",e=>{this.onTouchEnd(e)}),t.addEventListener("touchcancel",e=>{}),document.body.appendChild(this.hud.domElement)}init(){return this.setupAmmo(),this.setupScene(),window.addEventListener("resize",()=>{this.onResize()}),this.hud.numObjects=this.objects.length,this}start(){let e=!1;return setInterval(()=>{this.updateLoop(1/60),e||(e=!0,requestAnimationFrame(()=>{e=!1,this.render(),this.fpsCounter+=1}))},1e3/60),setInterval(()=>{this.hud.fps=this.fpsCounter,this.fpsCounter=0},1e3),this}setupScene(){this.scene.add(this.camera),this.scene.add(this.player.object3D);const t=new THREE.TextureLoader;Promise.all([new Promise((e,o)=>t.load("./textures/dirty_concrete_1k_jpg/dirty_concrete_diff_1k.jpg",t=>e(t),void 0,e=>o(e))),new Promise((e,o)=>t.load("./textures/dirty_concrete_1k_jpg/dirty_concrete_nor_1k.jpg",t=>e(t),void 0,e=>o(e))),new Promise((e,o)=>t.load("./textures/dirty_concrete_1k_jpg/dirty_concrete_rough_1k.jpg",t=>e(t),void 0,e=>o(e)))]).then(e=>{const t=e[0],n=e[1],s=e[2];e.forEach(e=>{e.anisotropy=16,e.needsUpdate=!0}),o.map=t,o.normalMap=n,o.normalMapType=THREE.TangentSpaceNormalMap,o.roughnessMap=s,o.needsUpdate=!0});const o=new THREE.MeshStandardMaterial({metalness:0,side:THREE.BackSide}),s=new THREE.Mesh(new THREE.BoxBufferGeometry(10,10,10),o);s.position.set(0,5,0),s.castShadow=!1,s.receiveShadow=!0,this.scene.add(s),a.setValue(5,5,5);const i=new Ammo.btCompoundShape;r.setIdentity(),a.setValue(0,-5.5,0),r.setOrigin(a),a.setValue(5,.5,5),i.addChildShape(r,new Ammo.btBoxShape(a)),r.setIdentity(),a.setValue(0,5.5,0),r.setOrigin(a),a.setValue(5,.5,5),i.addChildShape(r,new Ammo.btBoxShape(a)),r.setIdentity(),a.setValue(5.5,0,0),r.setOrigin(a),a.setValue(.5,5,5),i.addChildShape(r,new Ammo.btBoxShape(a)),r.setIdentity(),a.setValue(-5.5,0,0),r.setOrigin(a),a.setValue(.5,5,5),i.addChildShape(r,new Ammo.btBoxShape(a)),r.setIdentity(),a.setValue(0,0,-5.5),r.setOrigin(a),a.setValue(5,5,.5),i.addChildShape(r,new Ammo.btBoxShape(a)),r.setIdentity(),a.setValue(0,0,5.5),r.setOrigin(a),a.setValue(5,5,.5),i.addChildShape(r,new Ammo.btBoxShape(a));const d=new e.Object(0,i,s);this.world.addRigidBody(d.rigidBody,1,4294967295),this.objects.push(d),this.camera.position.set(0,2,0),this.camera.up.set(0,1,0),this.player.object3D.add(this.camera);const l=new THREE.SpotLight(new THREE.Color(.9,.9,.9));l.angle=Math.PI/8,l.penumbra=.2,l.shadow.mapSize.set(1024,1024),l.shadow.camera.fov=l.angle,l.target=new THREE.Object3D,l.castShadow=!0,this.scene.add(l),this.light=l;const h=new THREE.AmbientLight(new THREE.Color(.2,.2,.2));this.scene.add(h),this.scene.fog=new THREE.Fog(0,5,12),this.setupTargets(),(new THREE.GLTFLoader).load("./models/corgishiba_texturing_challenge/scene.gltf",t=>{const o=t.scene;c(o);let s=0;o.traverse(t=>{if(t.isMesh){if(1==s){const o=t.geometry;o.computeBoundingSphere(),n.copy(o.boundingSphere.center).negate();const s=1/o.boundingSphere.radius;o.translate(n.x,n.y,n.z).scale(s,s,s).rotateY(Math.PI);const i=t.material;i.side=THREE.FrontSide,i.depthWrite=!0,i.needsUpdate=!0,this.setupSoftBody(o,i,new THREE.Vector3(0,1,-2)).softbody.setUserIndex(e.AudioIndex.ar)}s++}})}),this.addHangingBall(),this.addGrass()}setupAmmo(){const e=new Ammo.btSoftBodyRigidBodyCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),o=new Ammo.btDbvtBroadphase,n=new Ammo.btSequentialImpulseConstraintSolver,s=new Ammo.btDefaultSoftBodySolver,i=new Ammo.btSoftRigidDynamicsWorld(t,o,n,e,s);this.world=i}setupTargets(){const t=[new THREE.Vector3(0,0,0),new THREE.Vector3(-.5,0,1),new THREE.Vector3(.5,0,1),new THREE.Vector3(-1,0,2),new THREE.Vector3(0,0,2),new THREE.Vector3(1,0,2),new THREE.Vector3(-1.5,0,3),new THREE.Vector3(-.5,0,3),new THREE.Vector3(.5,0,3),new THREE.Vector3(1.5,0,3),new THREE.Vector3(-2,0,4),new THREE.Vector3(-1,0,4),new THREE.Vector3(0,0,4),new THREE.Vector3(1,0,4),new THREE.Vector3(2,0,4)];(new THREE.GLTFLoader).load("./models/bottle_old_wine/scene.gltf",o=>{const s=o.scene;c(s);const i=s.getObjectByName("bottle_05L_1_03_-_Default_0");let r=i.geometry;r.rotateX(-Math.PI/2),r.computeBoundingBox(),r.boundingBox.getCenter(n),r.translate(-n.x,-n.y,-n.z),r.boundingBox.getSize(n);const d=.4/n.x;r.scale(d,d,d),r.computeBoundingBox();const l=i.material,h=new THREE.ConvexHull;h.setFromObject(new THREE.Mesh(r));const m=new Ammo.btConvexHullShape,u=h.faces;for(let e=0;e<u.length;e++){const t=u[e];let o=t.edge;do{const e=o.head().point;a.setValue(e.x,e.y,e.z),m.addPoint(a),o=o.next}while(o!==t.edge)}m.setMargin(.005);const p=new Ammo.btVector3;m.calculateLocalInertia(1,p);const f=r.boundingBox.getSize(n).y;t.forEach(e=>{e.add(new THREE.Vector3(0,.5,-2.5)).multiply(new THREE.Vector3(.96,f,.8))});for(let o of t){const t=new THREE.Mesh(r,l);t.castShadow=!0,t.receiveShadow=!0,t.position.copy(o),this.scene.add(t);const n=new e.Object(1,m,t,p);n.rigidBody.setUserIndex(e.AudioIndex.bottlelHit),this.world.addRigidBody(n.rigidBody,1,-1),this.objects.push(n)}Ammo.destroy(p)})}setupSoftBody(t,o,n){const s=new e.SoftBody(this.world.getWorldInfo(),t.clone().translate(n.x,n.y,n.z)),i=new THREE.Mesh(s.geometry,o);return i.receiveShadow=!0,i.castShadow=!0,this.scene.add(i),this.world.addSoftBody(s.softbody,1,-1),this.softBodies.push(s),s}addHangingBall(){(new THREE.GLTFLoader).load("./models/wood_stick_04/scene.gltf",t=>{const o=t.scene;c(o);const s=o.getObjectByName("wood_stick_04_wood_stick_04_0"),i=s.geometry;i.rotateY(Math.PI/2),i.computeBoundingBox(),i.boundingBox.getCenter(n),i.translate(-n.x,-n.y,-n.z),i.boundingBox.getSize(n);const r=.4/n.y;i.scale(r,r,r),i.computeBoundingBox();const l=new THREE.Mesh(i,s.material);l.receiveShadow=!0,l.castShadow=!0,l.position.set(0,2,0),this.scene.add(l),i.boundingBox.getSize(n),a.setValue(n.x/2,n.y/2,n.z/2);const h=new Ammo.btCylinderShapeX(a),m=new d(0,h,l);this.world.addRigidBody(m.rigidBody,1,-1),this.objects.push(m);const u=new THREE.MeshStandardMaterial({metalness:0}),p=new THREE.TextureLoader;p.load("./textures/fabric_leather_01_1k_jpg/fabric_leather_01_diff_1k.jpg",e=>{u.map=e,u.needsUpdate=!0}),p.load("./textures/fabric_leather_01_1k_jpg/fabric_leather_01_nor_1k.jpg",e=>{u.normalMap=e,u.normalMapType=THREE.TangentSpaceNormalMap,u.needsUpdate=!0}),p.load("./textures/fabric_leather_01_1k_jpg/fabric_leather_01_rough_1k.jpg",e=>{u.roughnessMap=e,u.needsUpdate=!0});for(let t=0;t<3;t++){const o=new THREE.SphereBufferGeometry(.5,16,16),n=this.setupSoftBody(o,u,new THREE.Vector3(t-1,1.5));n.softbody.getCollisionShape().setMargin(.1),n.softbody.setUserIndex(e.AudioIndex.punch);for(let e=0;e<n.softbody.m_nodes.size();e++){const t=n.softbody.m_nodes.at(e);Math.abs(t.m_x.y()-2)<1e-4&&n.softbody.appendAnchor(e,m.rigidBody,!0,1)}}c(this.scene)})}addWater(){const t=new e.WaterPlane;t.position.set(0,.1,0),this.scene.add(t)}addGrass(){THREE.MathUtils.seededRandom(.93738);const t=(new THREE.Matrix4).makeRotationX(-Math.PI/2).premultiply(i.makeScale(.005,.005,.005)),o=new Array(100);for(let e=0;e<o.length;e++){const n=1*THREE.MathUtils.seededRandom()+.2;o[e]=(new THREE.Matrix4).copy(t).premultiply(i.makeScale(1,n,1)).premultiply(i.makeRotationY(THREE.MathUtils.seededRandom()*Math.PI*2)).premultiply(i.makeTranslation(5*(2*THREE.MathUtils.seededRandom()-1),0,5*(2*THREE.MathUtils.seededRandom()-1)))}(new THREE.GLTFLoader).load("./models/clover_grass/scene.gltf",t=>{t.scene.traverse(t=>{if(t.isMesh){const n=e.GrassWinding.modify(t.material),s=new THREE.InstancedMesh(t.geometry,n,o.length);s.customDepthMaterial=s.customDistanceMaterial=e.GrassWinding.modify(new THREE.MeshDepthMaterial({map:t.material.map,alphaTest:t.material.alphaTest})),s.castShadow=!0,s.receiveShadow=!0;for(let e=0;e<o.length;e++)s.setMatrixAt(e,o[e]);this.scene.add(s)}})})}setupPassControl(){const e=document.createElement("div");e.style.position="absolute",e.style.right="0",e.style.top="0",e.style.backgroundColor="white",e.innerHTML="<div>Pass:</div>";for(let t of this.passes){const o=t[0],n=t[1],s=document.createElement("div"),i=document.createElement("input");i.type="checkbox",i.checked=n.enabled,i.onchange=(e=>{n.enabled=e.target.checked}),s.innerHTML=`${o}`,s.appendChild(i),e.appendChild(s)}document.body.appendChild(e)}updateLoop(e){this.timeElapsed+=e;const t=2*Math.PI*this.timeElapsed/10;this.light.position.set(10*-Math.cos(t),20,10*Math.sin(t)),this.player.update(this,e),this.world.stepSimulation(e),this.traceContact();for(let t of this.objects)t.update(e);for(let t of this.softBodies)t.update(this,e);this.pointerMove.set(0,0)}traceContact(){const e=this.world.getDispatcher(),t=e.getNumManifolds();for(let o=0;o<t;o++){const t=e.getManifoldByIndexInternal(o),n=t.getNumContacts(),s=t.getBody0(),i=t.getBody1();let a=0;for(let e=0;e<n;e++)a+=t.getContactPoint(e).getAppliedImpulse();0!=n&&(a/=n);for(let e of[{a:s,b:i},{a:i,b:s}]){const t=this.contacts.get(e.a)||new WeakMap;t.get(e.b)!=n&&(t.set(e.b,n),this.contacts.set(e.a,t),a>1&&this.audio.playSoundByIndex(e.a.getUserIndex()))}}}render(){this.effectComposer.render(1/60)}onMouseDown(e){this.mousePressed=!0;const t=e.target.getBoundingClientRect();o.set(t.width,t.height),this.pointerPosition.set(e.offsetX,e.offsetY).divide(o).multiplyScalar(2).addScalar(-1).multiply(s)}onMouseUp(e){this.mousePressed=!1,this.pointerMove.set(0,0)}onMouseMove(e){const n=e.target.getBoundingClientRect();o.set(n.width,n.height),this.pointerPosition.set(e.offsetX,e.offsetY).divide(o).multiplyScalar(2).addScalar(-1).multiply(s),this.mousePressed&&(t.set(e.movementX,e.movementY).divideScalar(o.y).multiply(s),this.pointerMove.add(t))}onTouchStart(e){this.mousePressed=!0;const t=e.target.getBoundingClientRect();o.set(t.width,t.height);for(let t of e.touches)this.pointerPosition.set(t.clientX,t.clientY).divide(o).multiplyScalar(2).addScalar(-1).multiply(s)}onTouchMove(e){const t=e.target.getBoundingClientRect();o.set(t.width,t.height);for(let t of e.touches)this.pointerPosition.set(t.clientY,t.clientY).divide(o).multiplyScalar(2).addScalar(-1).multiply(s)}onTouchEnd(e){this.mousePressed=!1,this.pointerMove.set(0,0)}onResize(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height,this.renderer.setSize(e.width,e.height),this.renderer.setViewport(0,0,e.width,e.height),this.camera.aspect=e.width/e.height,this.camera.updateProjectionMatrix(),this.effectComposer.setSize(e.width,e.height)}}}(hahaApp||(hahaApp={})),function(e){class t{}t.baseballHit=1,t.bottlelHit=2,t.punch=3,t.ar=4,e.AudioIndex=t;e.AudioManager=class{constructor(){this.context=new AudioContext,this.audioBuffers={};const e=this.context.createGain();e.gain.setValueAtTime(.05,0),e.connect(this.context.destination),this.outputNode=e;const t={throw:"./sound/419341__wizardoz__swoosh.ogg",baseballHit:"./sound/516974__plucinskicasey__normalpunch.wav",bottlelHit:"./sound/178660__hanbaal__bottle-tink2.wav",punch:"./sound/81042__rock-savage__blood-hitting-window.wav",ar:"./sound/ar.mp3"};for(let e in t){const o=e;this.createBuffer(t[o]).then(e=>{this.audioBuffers[o]=e})}}get rootNode(){return this.outputNode}playSound(e){const t=this.context.createBufferSource();t.buffer=this.audioBuffers[e],t.connect(this.rootNode),t.start()}playSoundByIndex(e){switch(e){case t.baseballHit:this.playSound("baseballHit");break;case t.bottlelHit:this.playSound("bottlelHit");break;case t.punch:this.playSound("punch");break;case t.ar:this.playSound("ar")}}createBuffer(e){return __awaiter(this,void 0,void 0,function*(){const t=yield(yield fetch(e)).arrayBuffer();return this.context.decodeAudioData(t)})}}}(hahaApp||(hahaApp={})),function(e){const t={value:performance.now()/1e3};setInterval(()=>{t.value+=1/60},1e3/60);e.GrassWinding=class{static modify(e){(e.defines||(e.defines={})).GRASS_WINDING="1";const o=e.onBeforeCompile;return e.onBeforeCompile=((e,n)=>{o(e,n),e.uniforms.grassWindTime=t,e.vertexShader="\n                    uniform float grassWindTime;\n                "+e.vertexShader.replace("#include <project_vertex>","\n                    #include <project_vertex>\n\n                    float phaseX = ( mvPosition.x + grassWindTime/3.0 ) * PI * 2.0;\n                    float phaseZ = ( mvPosition.z + grassWindTime/3.0 ) * PI * 2.0;\n                    float str = mvPosition.y*0.01;\n                    mvPosition.x += cos( phaseX )*str;\n                    mvPosition.z -= sin( phaseZ )*str;\n\n                    gl_Position = projectionMatrix * mvPosition;\n                    ")}),e}}}(hahaApp||(hahaApp={})),function(e){e.HUD=class{constructor(){this._fps=0,this._numObjects=0,this.domElement=document.createElement("div"),this.domElement.style.position="absolute",this.domElement.style.left="10",this.domElement.style.top="10",this.domElement.style.userSelect="none"}set fps(e){this._fps=e,this.update()}set numObjects(e){this._numObjects=e,this.update()}update(){this.domElement.innerHTML=`<font color="white">FPS: ${this._fps}</font>`}}}(hahaApp||(hahaApp={})),function(e){const t=.02,o=1,n=30;let s;const i=new Ammo.btSphereShape(.2),a=new Ammo.btVector3;i.calculateLocalInertia(o,a),(new THREE.GLTFLoader).load("./models/worn_baseball_ball/scene.gltf",t=>{const o=t.scene;e.setAnisotropic(o);const n=o.getObjectByName("polySurface5_lambert1_0"),i=n.material,a=n.geometry;a.computeBoundingSphere(),c.copy(a.boundingSphere.center).negate();const r=.2/a.boundingSphere.radius;a.translate(c.x,c.y,c.z).scale(r,r,r),s={material:i,geometry:a}});const r=new THREE.Matrix4,d=new THREE.Matrix4,c=new THREE.Vector3,l=new THREE.Vector4,h=new Ammo.btVector3;e.Player=class{constructor(){this.object3D=new THREE.Object3D,this.fireBallCooldown=0,this.circling={angle:0,distance:5}}update(e,t){this.movement(e,t),this.firingBalls(e,t)}movement(e,t){this.object3D.position.set(Math.sin(this.circling.angle)*this.circling.distance,0,-Math.cos(this.circling.angle)*this.circling.distance),e.camera.lookAt(0,0,0)}firingBalls(e,o){this.fireBallCooldown-=o,e.mousePressed&&this.fireBallCooldown<0&&(this.fireBall(e),this.fireBallCooldown=t)}fireBall(t){if(null==s)return;r.multiplyMatrices(t.camera.projectionMatrix,t.camera.matrixWorldInverse),d.copy(r).invert(),l.set(t.pointerPosition.x,t.pointerPosition.y,0,1),l.applyMatrix4(d),l.divideScalar(l.w);const m=new THREE.Mesh(s.geometry,s.material);m.castShadow=!0,m.receiveShadow=!0,m.position.set(l.x,l.y,l.z),m.quaternion.set(Math.random(),Math.random(),Math.random(),Math.random()).normalize(),t.scene.add(m);const u=new e.Object(o,i,m,a);c.setFromMatrixPosition(t.camera.matrixWorld).sub(m.position).multiplyScalar(-1),c.x+=.01*Math.random(),c.y+=.01*Math.random(),c.z+=.01*Math.random(),c.normalize().multiplyScalar(n),h.setValue(c.x,c.y,c.z),u.rigidBody.setLinearVelocity(h),u.rigidBody.setUserIndex(e.AudioIndex.baseballHit),t.world.addRigidBody(u.rigidBody,1,-1),t.objects.push(u),t.hud.numObjects=t.objects.length,t.audio.playSound("throw")}}}(hahaApp||(hahaApp={})),function(e){const t=1e-4,o=new THREE.Vector3;function n(e){return`${Math.round(e.x/t)},${Math.round(e.y/t)},${Math.round(e.z/t)}`}e.SoftBody=class{constructor(e,s){this.soundCooldown=1,this.geometry=s;const i=function(e){const s=e.clone();for(let e in s.attributes)switch(e){case"position":break;default:s.deleteAttribute(e)}const i=THREE.BufferGeometryUtils.mergeVertices(s,t),a=i.attributes.position,r=i.index,d=new Map;for(let e=0;e<a.count;e++)o.fromBufferAttribute(a,e),d.set(n(o),e);const c=e.attributes.position,l=new Array(c.count);for(let e=0;e<c.count;e++)o.fromBufferAttribute(c,e),l[e]=d.get(n(o));return{position:Array.from(a.array),index:Array.from(r.array),mapping:l}}(s),a=new Ammo.btSoftBodyHelpers;this.softbody=a.CreateFromTriMesh(e,i.position,i.index,i.index.length/3,!0),this.softbody.m_cfg.kPR=5,this.softbody.m_cfg.viterations=10,this.softbody.m_cfg.piterations=10,this.softbody.setTotalMass(.1,!0),this.softbody.getCollisionShape().setMargin(.05),this.mapping=i.mapping,Ammo.destroy(a)}update(e,t){this.soundCooldown-=t;const o=this.geometry.attributes.position,n=this.geometry.attributes.normal,s=o.count,i=new THREE.Vector3,a=new THREE.Vector3;let r=0;for(let e=0;e<s;e++){const t=this.softbody.m_nodes.at(this.mapping[e]),s=t.m_x,d=t.m_n;i.fromBufferAttribute(o,e),a.set(s.x(),s.y(),s.z()),r=Math.max(r,i.distanceTo(a)),o.setXYZ(e,s.x(),s.y(),s.z()),n.setXYZ(e,d.x(),d.y(),d.z())}o.needsUpdate=!0,n.needsUpdate=!0,r>.2&&this.soundCooldown<=0&&(e.audio.playSoundByIndex(this.softbody.getUserIndex()),this.soundCooldown=.5)}}}(hahaApp||(hahaApp={})),function(e){const t=new THREE.Vector2(0,0),o=new THREE.Matrix4,n=new THREE.Vector2;THREE.ShaderChunk.quaternion="\n\n        vec4 quaternionFromUnitVectors( vec3 vFrom, vec3 vTo ){\n            // assumes direction vectors vFrom and vTo are normalized\n\n            vec4 q;\n\n            float EPS = 0.000001;\n\n            float r = dot(vFrom, vTo ) + 1.0;\n\n            if ( r < EPS ) {\n\n                r = 0.0;\n\n                if ( abs( vFrom.x ) > abs( vFrom.z ) ) {\n\n                    q.x = - vFrom.y;\n                    q.y = vFrom.x;\n                    q.z = 0.0;\n                    q.w = r;\n\n                } else {\n\n                    q.x = 0.0;\n                    q.y = - vFrom.z;\n                    q.z = vFrom.y;\n                    q.w = r;\n\n                }\n\n            } else {\n\n                // crossVectors( vFrom, vTo ); // inlined to avoid cyclic dependency on Vector3\n\n                q.x = vFrom.y * vTo.z - vFrom.z * vTo.y;\n                q.y = vFrom.z * vTo.x - vFrom.x * vTo.z;\n                q.z = vFrom.x * vTo.y - vFrom.y * vTo.x;\n                q.w = r;\n\n            }\n\n            return normalize(q);\n\n        }\n\n        vec3 applyQuaternion( vec3 v, vec4 q ){\n            vec3 result;\n            \n            float x = v.x, y = v.y, z = v.z;\n            float qx = q.x, qy = q.y, qz = q.z, qw = q.w;\n    \n            // calculate quat * vector\n    \n            float ix = qw * x + qy * z - qz * y;\n            float iy = qw * y + qz * x - qx * z;\n            float iz = qw * z + qx * y - qy * x;\n            float iw = - qx * x - qy * y - qz * z;\n    \n            // calculate result * inverse quat\n    \n            result.x = ix * qw + iw * - qx + iy * - qz - iz * - qy;\n            result.y = iy * qw + iw * - qy + iz * - qx - ix * - qz;\n            result.z = iz * qw + iw * - qz + ix * - qy - iy * - qx;\n    \n            return result;\n        }\n\n    ";class s extends THREE.MeshStandardMaterial{constructor(){super({transparent:!0,blending:THREE.NoBlending}),this.uniforms={tFramebuffer:{value:null},framebufferSize:{value:new THREE.Vector2(0,0)},waterTransforms:{value:[new THREE.Matrix4,new THREE.Matrix4,new THREE.Matrix4]},time:{value:0}},(this.defines||(this.defines={})).WATER_TRANSFORM_COUNT=this.uniforms.waterTransforms.value.length.toString();const e=this.onBeforeCompile;this.onBeforeCompile=((t,o)=>{e(t,o),t.uniforms.tFramebuffer=this.uniforms.tFramebuffer,t.uniforms.framebufferSize=this.uniforms.framebufferSize,t.uniforms.waterTransforms=this.uniforms.waterTransforms,t.uniforms.time=this.uniforms.time,t.vertexShader="\n                    uniform float time;\n                "+t.vertexShader.replace("#include <project_vertex>","\n\n                    float phase = PI*2.0*(transformed.x/2.0+time);\n                    transformed.y += (cos( phase ) - sin(  phase ))*0.01;\n\n                    #include <project_vertex>\n                    "),t.fragmentShader="\n                    #include <quaternion>\n\n                    uniform sampler2D tFramebuffer;\n                    uniform vec2 framebufferSize;\n                    uniform mat4 waterTransforms[WATER_TRANSFORM_COUNT];\n                "+t.fragmentShader.replace("#include <normal_fragment_maps>","\n                    #ifdef USE_UV\n                    vec3 n = vec3(0,0,0);\n                    for( int i=0; i<WATER_TRANSFORM_COUNT; i++  ){\n                        vec2 uv = (waterTransforms[i]*vec4(vUv,0,1)).xy;\n                        n += texture2D( normalMap, uv ).rgb*2.0-1.0;\n                    }\n                    n = normalize( n );\n\n                    vec4 q = quaternionFromUnitVectors( vec3(0,0,1),  normal );\n                    normal = applyQuaternion( n, q );\n                    #endif\n                    ").replace("#include <dithering_fragment>","\n                    #include <dithering_fragment>\n\n                    vec2 framebufferUV = gl_FragCoord.xy/framebufferSize;\n\n                    vec2 offset = normalize(refract( normalize(-vViewPosition), normal, 1.0/1.33 )).xy*0.01;\n\n                    framebufferUV += offset;\n                    vec4 framebufferColor = texture2D( tFramebuffer, framebufferUV );\n\n                    gl_FragColor.rgb = mix( gl_FragColor.rgb, framebufferColor.xyz, 0.9 );\n\n                    ")}),(new THREE.TextureLoader).load("./textures/9110-normal.jpg",e=>{e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.anisotropy=16,e.generateMipmaps=!0,e.minFilter=THREE.LinearMipMapLinearFilter,e.magFilter=THREE.LinearFilter,e.needsUpdate=!0,this.normalMap=e,this.needsUpdate=!0})}}e.WaterPlane=class extends THREE.Mesh{constructor(){const e=new THREE.Vector2(0,0);let i;const a=new s;super(new THREE.PlaneBufferGeometry(10,10,50,50).rotateX(-Math.PI/2),a),this.onBeforeRender=((s,r,d)=>{s.getDrawingBufferSize(n),(e.x<n.x||e.y<n.y)&&(e.x=THREE.Math.ceilPowerOfTwo(n.x),e.y=THREE.Math.ceilPowerOfTwo(n.y),(i=new THREE.DataTexture(null,e.x,e.y,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter,16)).needsUpdate=!0,a.uniforms.tFramebuffer.value=i,a.uniforms.framebufferSize.value.copy(e)),(0,s.copyFramebufferToTexture)(t,i);const c=a.uniforms.waterTransforms.value;for(let e=0;e<c.length;e++)c[e].makeTranslation(.5*performance.now()/1e3,0,0).multiply(o.makeRotationZ(e*Math.PI*4/3)).multiply(o.makeScale(5,5,5));a.uniforms.time.value=performance.now()/1e3}),this.receiveShadow=!0,this.castShadow=!1}}}(hahaApp||(hahaApp={}));